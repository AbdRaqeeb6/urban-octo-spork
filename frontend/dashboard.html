<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<title>Dashboard | BudgetPro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Export libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* ================= THEME ================= */
:root {
  --bg:#eef2ff;
  --surface:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
}

[data-theme="dark"] {
  --bg:#020617;
  --surface:#0f172a;
  --text:#e5e7eb;
  --muted:#94a3b8;
}

body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* ================= LAYOUT ================= */
.container{display:flex;min-height:100vh}

/* ================= SIDEBAR ================= */
.sidebar{
  width:320px;
  background:linear-gradient(180deg,#0f172a,#1e3a8a);
  color:white;
  padding:24px;
}
.sidebar h2{margin-bottom:40px}
.sidebar a{
  display:flex;gap:14px;
  padding:16px 20px;
  margin-bottom:14px;
  color:#e5e7eb;text-decoration:none;
  border-radius:16px;
}
.sidebar a:hover,.sidebar a.active{
  background:rgba(255,255,255,.15)
}

/* ================= MAIN ================= */
.main{flex:1;padding:40px}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:36px
}
.header button{
  padding:10px 14px;
  border:none;
  border-radius:12px;
  background:#2563eb;
  color:white;
  font-weight:600;
  cursor:pointer;
  margin-left:8px;
}

/* ================= KPI GROUPS ================= */
.kpi-primary{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:28px;
  margin-bottom:36px;
}

.kpi-secondary{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:28px;
  margin-bottom:40px;
}

/* ================= KPI CARD ================= */
.kpi{
  color:white;
  padding:28px;
  border-radius:22px;
  box-shadow:0 22px 45px rgba(0,0,0,.18);
  transition:transform .25s, box-shadow .25s;
}
.kpi:hover{
  transform:translateY(-6px);
  box-shadow:0 30px 60px rgba(0,0,0,.28);
}
.kpi i{font-size:28px;opacity:.9}
.kpi h4{margin:14px 0 6px;font-size:14px;opacity:.85}
.kpi h2{margin:0;font-size:32px}
.kpi small{opacity:.85}

/* ================= KPI COLORS ================= */
.green{background:linear-gradient(135deg,#15803d,#22c55e)}
.red{background:linear-gradient(135deg,#991b1b,#ef4444)}
.blue{background:linear-gradient(135deg,#1e40af,#3b82f6)}
.purple{background:linear-gradient(135deg,#5b21b6,#a855f7)}
.amber{
  background:linear-gradient(135deg,#b45309,#f59e0b);
  color:#1f2937
}

/* ================= CHARTS ================= */
.chart-grid{
  display:grid;
  grid-template-columns:1.6fr 1.2fr;
  gap:32px;
  max-width:1300px;
}

.card{
  background:var(--surface);
  padding:24px;
  border-radius:22px;
  box-shadow:0 20px 40px rgba(0,0,0,.12);
}

/* CHART BOX FIX (IMPORTANT) */
.chart-box{
  width:100%;
  height:300px;
  position:relative;
}
.chart-box canvas{
  width:100% !important;
  height:100% !important;
}
</style>
</head>

<body>

<div class="container">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>üí∞ BudgetPro</h2>
    <a class="active" href="/dashboard"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
    <a href="/expenses"><i class="fa-solid fa-wallet"></i> Expenses</a>
    <a href="/budget"><i class="fa-solid fa-piggy-bank"></i> Budget</a>
    <a href="/reports"><i class="fa-solid fa-file-lines"></i> Reports</a>
    <a href="/" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <div class="header">
      <h1>Financial Overview</h1>
      <div>
        <button onclick="exportPDF()">üìÑ PDF</button>
        <button onclick="exportWord()">üìù Word</button>
        <button onclick="exportPPT()">üìä PPT</button>
        <button onclick="toggleDark()">üåô Dark</button>
      </div>
    </div>

    <!-- KPIs -->
    <section class="kpi-primary">
      <div class="kpi green">
        <i class="fa-solid fa-coins"></i>
        <h4>Total Budget</h4>
        <h2 id="income">GHS 0</h2>
        <small>Planned capacity</small>
      </div>

      <div class="kpi red">
        <i class="fa-solid fa-arrow-trend-down"></i>
        <h4>Total Expenses</h4>
        <h2 id="expenses">GHS 0</h2>
        <small>Actual spending</small>
      </div>

      <div class="kpi blue">
        <i class="fa-solid fa-scale-balanced"></i>
        <h4>Net Balance</h4>
        <h2 id="balance">GHS 0</h2>
        <small>Remaining strength</small>
      </div>
    </section>

    <section class="kpi-secondary">
      <div class="kpi purple">
        <i class="fa-solid fa-gauge-high"></i>
        <h4>Budget Utilisation</h4>
        <h2><span id="utilisation">0</span>%</h2>
        <small>Consumption intensity</small>
      </div>

      <div class="kpi amber">
        <i class="fa-solid fa-clock"></i>
        <h4>Forecast</h4>
        <h2 id="forecastDays">‚Äî</h2>
        <small>Days to exceed budget</small>
      </div>
    </section>

    <!-- CHARTS -->
    <div class="chart-grid">
      <div class="card">
        <h3>Expenses by Category (Column)</h3>
        <div class="chart-box">
          <canvas id="barChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h3>Spending Share (Pie)</h3>
        <div class="chart-box">
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
/* ================= THEME ================= */
function applyTheme(){
  const t = localStorage.getItem("theme") || "light";
  document.documentElement.setAttribute("data-theme", t);
}
function toggleDark(){
  const t = (localStorage.getItem("theme") || "light") === "dark" ? "light" : "dark";
  localStorage.setItem("theme", t);
  applyTheme();
}
applyTheme();

/* ================= LOGIC ================= */
function logout(){ localStorage.clear(); }

async function loadSummary(){
  const r = await fetch("/net-balance");
  const d = await r.json();

  income.innerText = `GHS ${d.total_income}`;
  expenses.innerText = `GHS ${d.total_expenses}`;
  balance.innerText = `GHS ${d.net_balance}`;
  utilisation.innerText = d.budget_utilisation;
  forecastDays.innerText = d.forecast_days ? `${d.forecast_days} days` : "‚Äî";
}

async function loadCharts(){
  const r = await fetch("/expenses-by-category");
  const d = await r.json();

  const labels = d.map(x=>x.category);
  const values = d.map(x=>x.total);
  const colors = ["#22c55e","#ef4444","#3b82f6","#f59e0b","#a855f7"];

  new Chart(barChart,{
    type:"bar",
    data:{ labels, datasets:[{ data:values, backgroundColor:colors, borderRadius:10 }] },
    options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });

  new Chart(pieChart,{
    type:"pie",
    data:{ labels, datasets:[{ data:values, backgroundColor:colors }] },
    options:{ responsive:true, maintainAspectRatio:false }
  });
}

/* ================= EXPORTS ================= */
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("landscape","pt","a4");
  const canvas = await html2canvas(document.querySelector(".main"),{scale:2});
  pdf.addImage(canvas.toDataURL("image/png"),"PNG",0,20,840,480);
  pdf.save("BudgetPro-Dashboard.pdf");
}

async function exportPPT(){
  const pptx = new PptxGenJS();
  const slide = pptx.addSlide();
  const canvas = await html2canvas(document.querySelector(".main"),{scale:2});
  slide.addImage({ data: canvas.toDataURL("image/png"), x:0.2, y:0.3, w:9.6, h:5.2 });
  pptx.writeFile("BudgetPro-Dashboard.pptx");
}

function exportWord(){
  const text = `
BudgetPro Dashboard

Total Budget: ${income.innerText}
Total Expenses: ${expenses.innerText}
Net Balance: ${balance.innerText}
Utilisation: ${utilisation.innerText}%
Forecast: ${forecastDays.innerText}
`;
  saveAs(new Blob([text],{type:"application/msword"}),"BudgetPro-Dashboard.doc");
}

loadSummary();
loadCharts();
</script>
<script src="/frontend/sync.js"></script>

</body>
</html>
